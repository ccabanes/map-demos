
<!-- saved from url=(0025)http://leaflet.melard.fr/ -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<title>WMTS examples</title>

<meta charset="UTF-8">

<meta name="viewport" content="width=device-width">

<link rel="stylesheet" href="css/leaflet.css">
<link rel="stylesheet" href="css/L.Control.MousePosition.css">
     
<script src="lib/leaflet-src.js"></script>
<script src="lib/proj4-compressed.js"></script>
<script src="src/proj4leaflet.js"></script>
<script src="lib/leaflet-tilelayer-wmts-src.js"></script>
<script src="lib/L.Control.MousePosition.js"></script>
<script src="lib/jquery-1.12.0.min.js"></script>

</head>

<body class="">
	<div id="map_3857" style="height: 33%; width: 100%; position: relative;"></div>
	<div id="map_4326" style="height: 33%; width: 100%; position: relative;"></div>
	<div id="map_25830" style="height: 33%; width: 100%; position: relative;"></div>
<script>

	var url = "http://www.ign.es/wmts/pnoa-ma?";
	var urltopo= "http://terramapas.icv.gva.es/topografico/wmts/";
	var wmtsParams="service=WMTS&request=GetCapabilities";
	
	$( document ).ready(function(){

	$.ajax({
		  url: url+wmtsParams,
		}).done(function(response) {						
	  	console.log("Capabilities XML: %O", response);
	}).fail(function(e){
		console.log("Error: " + e);
	});


/*
	var crsETRS89 = L.CRS.proj4js('EPSG:25830', '+proj=utm +zone=30 +ellps=GRS80 +units=m +no_defs', 
		[207256.000000,4140229.000000,1209991.000000,4565432.000000], 
		{
			resolutions: [610.35123300645204835746,305.17561650322744526420,152.58780825161315419791,76.29390412580644920126,38.14695206290335960375,19.07347603145165138017,9.53673801572581147923,3.96874785750115641747,2.64583190500077103380,1.98437392875057820874,1.32291595250038551690,0.66145797625019273625,0.26458319050007705897,0.13229159525003852949],						
			origin:[0.0, 0.0]
			
		});
*/
	
var crsETRS89 = new L.Proj.CRS.TMS('EPSG:25830',
   '+proj=utm +zone=30 +ellps=GRS80 +units=m +no_defs',
    [207256.000000,4140229.000000,1209991.000000,4565432.000000], 
    {
        origin: [0, 0],
        resolutions: [
              610.35123300645204835746,305.17561650322744526420,152.58780825161315419791,76.29390412580644920126,38.14695206290335960375,19.07347603145165138017,9.53673801572581147923,3.96874785750115641747,2.64583190500077103380,1.98437392875057820874,1.32291595250038551690,0.66145797625019273625,0.26458319050007705897,0.13229159525003852949
              ],
    }
);







var pnoaETRS89 = new L.Proj.CRS.TMS('EPSG:25830',
   '+proj=utm +zone=30 +ellps=GRS80 +units=m +no_defs',    
   [-1079526.5850090983,2500875.6941688014,1228424.5314746893,5056867.6606168505], 
    {
        origin: [0, 0],
        resolutions: [78271.51698,
			39135.75849,
			19567.87929,
			9783.9396225,
			4891.96981125,
			2445.984905625,
			1222.9924528125,
			611.4962264063,
			305.7481132031,
			152.8740566016,
			76.4370283008,
			38.2185141504,
			19.1092570752,
			9.5546285376,
			4.7773142688,
			2.3886571344,
			1.1943285672,
			0.5971642836,
			0.2985821418,
			0.1492910709,
              ],
    }
);

L.CRS.EPSG25830 = new L.Proj.CRS.TMS('EPSG:25830',
		   '+proj=utm +zone=30 +ellps=GRS80 +units=m +no_defs',
		    [207256.000000,4140229.000000,1209991.000000,4565432.000000], 
		    {
		        origin: [0, 0],
		        resolutions: [
		              610.35123300645204835746,305.17561650322744526420,152.58780825161315419791,76.29390412580644920126,38.14695206290335960375,19.07347603145165138017,9.53673801572581147923,3.96874785750115641747,2.64583190500077103380,1.98437392875057820874,1.32291595250038551690,0.66145797625019273625,0.26458319050007705897,0.13229159525003852949
		              ],
		    }
		);



  var proj25830 = L.CRS["EPSG25830"];
  var pos1 = new L.LatLng(21.899, -18.162);
  var pos12= new L.LatLng(45.286, 6.289 );
  var project1 = proj25830.projection.project(pos1);
  var project2 = proj25830.projection.project(pos12);
  
  console.log("coord1 %O", project1);
  console.log("coord2 %O", project2);






	var CRS_4326 = L.extend({}, L.CRS, {
		projection: L.extend({}, L.Projection.LonLat, {bounds:L.bounds([-180, -90], [180, 90])}),
		transformation: new L.Transformation(1 / 180, 1, -1 / 180, 0.5)
	});

	var CRS_3857 = L.CRS.EPSG3857;
	var CRS_25830 = pnoaETRS89;
	
	console.log("New 4326 %O",CRS_4326);
	console.log("Old 4326 %O",L.CRS.EPSG4326);
	
	var map = L.map('map_3857', {
	  crs: CRS_3857,
	  continuousWorld: true,
	  worldCopyJump: false
	}).setView([39.425, -0.37], 4);

	var map4326 = L.map('map_4326', {
	  crs: CRS_4326,
	  continuousWorld: true,
	  worldCopyJump: false
	}).setView([39.425, -0.37], 4);


	var map25830 = L.map('map_25830', {
	  crs: CRS_25830,
	  continuousWorld: true,
	  worldCopyJump: false
	}).setView([39.425, -0.37], 8);



	//Build matrix with zoom and topLeftCorner 4 4326CRS
	var matrix4326 = getMatrix("EPSG:4326:", new L.LatLng(90 ,-180),19);
	var matrix25830 = getMatrix25380();
	var matrix3857 = getMatrix("", new L.LatLng(20037508.3428,-20037508.3428),22);

	var layer3857 = createWMTSlayer(url, "OI.OrthoimageCoverage", "GoogleMapsCompatible", matrix3857);
	var layer4326 = createWMTSlayer(url, "OI.OrthoimageCoverage", "EPSG:4326", matrix4326,256);	
	//var layer25830 = createWMTSlayer(urltopo, "topografico", "ETRS89CV", matrix25830);
	var layer25830 = createWMTSlayer(url, "OI.OrthoimageCoverage", "EPSG:25830", matrix25830);

	console.log("3857 %O", matrix3857);
	console.log("25830 %O", matrix25830);

	map.addLayer(layer3857);	
	map4326.addLayer(layer4326);	
	map25830.addLayer(layer25830);

	L.control.mousePosition().addTo(map);
	L.control.mousePosition().addTo(map4326);
	L.control.mousePosition().addTo(map25830);

	L.control.scale({'position':'bottomleft','metric':true,'imperial':false}).addTo(map);
	L.control.scale({'position':'bottomleft','metric':true,'imperial':false}).addTo(map4326);
	L.control.scale({'position':'bottomleft','metric':true,'imperial':false}).addTo(map25830);

	}) 

	//Build id-leftCorner matrix 
	function getMatrix(iname, latLong, index){		
		var matrixId = new Array(index);
        for (var i= 0; i<index; i++) {
            matrixId[i]= {
                identifier    : iname? iname + i : "" + i,
                topLeftCorner : latLong         
            };
        }
        return matrixId;
	}

	function getMatrix25380(){
		var matrix = new Array(19);
		matrix[0]  = {identifier: 0, topLeftCorner : new L.LatLng(  22856087, -1968157.095 )};
        matrix[1]  = {identifier: 1, topLeftCorner : new L.LatLng(  12837333, -1968157.095 )};
        matrix[2]  = {identifier: 2, topLeftCorner : new L.LatLng(  7827955 , -1968157.095  )};
        matrix[3]  = {identifier: 3, topLeftCorner : new L.LatLng(  7827955 , -1968157.095  )};
        matrix[4]  = {identifier: 4, topLeftCorner : new L.LatLng(  7827955 , -1968157.095  )};
        matrix[5]  = {identifier: 5, topLeftCorner : new L.LatLng(  7827955 , -1968157.095  )};
        matrix[6]  = {identifier: 6, topLeftCorner : new L.LatLng(  7514869 , -1968157.095  )};
        matrix[7]  = {identifier: 7, topLeftCorner : new L.LatLng(  7358326 , -1968157.095  )};
        matrix[8]  = {identifier: 8, topLeftCorner : new L.LatLng(  7280055 , -1968157.095  )};
        matrix[9]  = {identifier: 9, topLeftCorner : new L.LatLng(  7280055 , -1968157.095  )};
        matrix[10] = {identifier:10, topLeftCorner : new L.LatLng(  7280055 , -1968157.095  )};
        matrix[11] = {identifier:11, topLeftCorner : new L.LatLng(  7280055 , -1968157.095  )};
        matrix[12] = {identifier:12, topLeftCorner : new L.LatLng(  7275163 , -1968157.095  )};
        matrix[13] = {identifier:13, topLeftCorner : new L.LatLng(  7272717 , -1968157.095  )};
        matrix[14] = {identifier:14, topLeftCorner : new L.LatLng(  7271494 , -1968157.095  )};
        matrix[15] = {identifier:15, topLeftCorner : new L.LatLng(  7272105 , -1968157.095  )};
        matrix[16] = {identifier:16, topLeftCorner : new L.LatLng(  7271800 , -1968157.095  )};
        matrix[17] = {identifier:17, topLeftCorner : new L.LatLng(  7271647 , -1968157.095  )};
        matrix[18] = {identifier:18, topLeftCorner : new L.LatLng(  7271570 , -1968157.095  )};
        matrix[19] = {identifier:19, topLeftCorner : new L.LatLng(  7271532 , -1968157.095  )};
        return matrix
    }

    function getTopograficoMatrix(){
    	var matrix = new Array(13);
		matrix[0]  = {identifier: 0, topLeftCorner : new L.LatLng(  4608978.746949, 207256  )};
        matrix[1]  = {identifier: 1, topLeftCorner : new L.LatLng(  4608978.746949, 207256  )};
        matrix[2]  = {identifier: 2, topLeftCorner : new L.LatLng(  4569916.268037, 207256  )};
        matrix[3]  = {identifier: 3, topLeftCorner : new L.LatLng(  4569916.268037, 207256  )};
        matrix[4]  = {identifier: 4, topLeftCorner : new L.LatLng(  4569916.268037, 207256  )};
        matrix[5]  = {identifier: 5, topLeftCorner : new L.LatLng(  4569916.268037, 207256  )};
        matrix[6]  = {identifier: 6, topLeftCorner : new L.LatLng(  4567474.863105, 207256  )};
        matrix[7]  = {identifier: 7, topLeftCorner : new L.LatLng(  4565932.770187, 207256  )};
        matrix[8]  = {identifier: 8, topLeftCorner : new L.LatLng(  4565594.103703, 207256  )};
        matrix[9]  = {identifier: 9, topLeftCorner : new L.LatLng(  4565932.770187, 207256  )};
        matrix[10] = {identifier:10, topLeftCorner : new L.LatLng(  4565594.103703, 207256  )};
        matrix[11] = {identifier:11, topLeftCorner : new L.LatLng(  4565594.103703, 207256  )};
        matrix[12] = {identifier:12, topLeftCorner : new L.LatLng(  4565458.637110, 207256  )};
        matrix[13] = {identifier:13, topLeftCorner : new L.LatLng(  4565458.637110, 207256  )};  return matrix;      
    }

    function createWMTSlayer(url, layer, tilematrixSet, matrix, tileSize){
		var layer = layer;
		var tilematrixSet = tilematrixSet;
		if(!tileSize){
			tileSize = 256;
		}
		var wmtsLayer = new L.TileLayer.WMTS( url ,
			           {
			               layer: layer,
			               style: "default",
			               tilematrixSet: tilematrixSet,
			               format: "image/png",
			               matrixIds: matrix, 
			               tileSize: tileSize
			           });
		return wmtsLayer;
    }
	
	//4326 resolutions
	//[0.703125, 0.3515625, 0.17578125, 0.087890625, 0.0439453125, 0.02197265625, 0.010986328125, 0.0054931640625, 0.00274658203125, 0.001373291015625, 0.0006866455078125, 0.00034332275390625, 0.000171661376953125, 0.0000858306884765625, 0.00004291534423828125, 0.000021457672119140625, 0.000010728836059570312, 0.000005364418029785156]
</script>
</body>
</html>